{% extends "reference.html" %}

{% block choose %}
<style>
  .chat-page {
    background: #f7f3eb; /* ë°”íƒ• ë°°ê²½ìƒ‰ (ìŠ¤í¬ë¦°ìƒ· ëŠë‚Œ) */
    padding: 40px 0 80px;
  }

  .chat-card {
    max-width: 720px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
    padding: 40px 48px 32px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    border: 1px solid
  }

  .chat-greeting {
    text-align: center;
  }

  .chat-greeting-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .chat-greeting-sub {
    font-size: 14px;
    color: #999;
  }

  .chat-quick-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }

  .chat-quick-btn {
    border-radius: 999px;
    border: 1px solid #e0d8cc;
    padding: 8px 16px;
    background: #f9f5ef;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.07s ease, box-shadow 0.12s ease;
  }

  .chat-quick-btn:hover {
    background: #f1e7d7;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    transform: translateY(-1px);
  }

  .chat-box {
    border-radius: 18px;
    background: #f5f5f7;
    border: 1px solid #e6e4de;
    padding: 16px 18px 12px;
    display: flex;
    flex-direction: column;
    height: 260px;  /* ìŠ¤í¬ë¦°ìƒ· ê°™ì€ ì§ì‚¬ê°í˜• ë†’ì´ */
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 4px;
    
  }

  .message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 9px 13px;
    border-radius: 14px;
    line-height: 1.4;
    white-space: pre-line;
    font-size: 14px;
  }

  .message.user {
    margin-left: auto;
    background: #222222;
    color: #ffffff;
    border-bottom-right-radius: 4px;
  }

  .message.bot {
    margin-right: auto;
    background: #ffffff;
    border: 1px solid #e1e1e6;
    border-bottom-left-radius: 4px;
  }

  .chat-input-row {
    margin-top: 8px;
    display: flex;
    gap: 8px;
  }

  .chat-input-row input[type='text'] {
    flex: 1;
    border-radius: 999px;
    border: 1px solid #d4d4dd;
    padding: 8px 14px;
    outline: none;
    font-size: 14px;
  }

  .chat-input-row input[type='text']:focus {
    border-color: #FFD369;
    box-shadow: 0 0 0 2px rgba(255, 179, 107, 0.25);
  }

  .chat-input-row button {
    border: none;
    border-radius: 999px;
    padding: 8px 18px;
    background: #FFD369;
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }

  .chat-input-row button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  .loading {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  @media (max-width: 768px) {
    .chat-card {
      margin: 0 16px;
      padding: 28px 20px 24px;
    }
    .chat-box {
      height: 220px;
    }
  }
</style>

<div class="chat-page">
  <div class="chat-card">
    <!-- ì¸ì‚¬ ì˜ì—­ -->
    <div class="chat-greeting">
      <div class="chat-greeting-title">ì•ˆë…•í•˜ì„¸ìš” OOë‹˜ ğŸ˜Š</div>
      <div class="chat-greeting-sub">ì˜¤ëŠ˜ì€ ì–´ë–¤ ì¹´í˜ë¥¼ ì„œì„±ì´ë©° ì°¾ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</div>
    </div>

    <!-- ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ -->
    {% comment %} <div class="chat-quick-row" id="quickButtons">
      <button class="chat-quick-btn" data-text="í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” ì¹´í˜ ì¶”ì²œí•´ì¤˜">
        í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” ì¹´í˜ ì°¾ê¸°
      </button>
      <button class="chat-quick-btn" data-text="í˜¼ì ì±… ì½ê±°ë‚˜ ì‘ì—…í•˜ê¸° ì¢‹ì€ ì¹´í˜ ì¶”ì²œí•´ì¤˜">
        í˜¼ì¹´í˜
      </button>
      <button class="chat-quick-btn" data-text="ê°€ì„±ë¹„ê°€ ì¢‹ì€ ì¹´í˜ ì¶”ì²œí•´ì¤˜">
        ê°€ì„±ë¹„ê°€ ì¢‹ì€ ì¹´í˜ ì°¾ê¸°
      </button>
    </div> {% endcomment %}

    <!-- ì±„íŒ… ë°•ìŠ¤ -->
    <div class="chat-box">
      <div id="chatMessages" class="chat-messages">
        <div class="message bot">
          ì•ˆë…•í•˜ì„¸ìš”! â˜•ï¸<br>
          ì˜ˆ: â€œì—°í¬ë™ì—ì„œ ì¡°ìš©í•˜ê³  ì½˜ì„¼íŠ¸ ë§ì€ ì¹´í˜ ì¶”ì²œí•´ì¤˜â€ ì²˜ëŸ¼ ë¬¼ì–´ë³´ë©´<br>
          ì„œì„±ì´ë‹¤ DBì—ì„œ ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ë¥¼ ì°¾ì•„ë“œë¦´ê²Œìš”.
        </div>
      </div>

      <form id="chatForm" class="chat-input-row">
        <input
          type="text"
          id="chatInput"
          placeholder="ì–´ë””ì„œ ëˆ„êµ¬ë‘, ì–´ë–¤ ë¶„ìœ„ê¸°ì˜ ì¹´í˜ë¥¼ ì°¾ê³  ìˆë‚˜ìš”?"
          autocomplete="off"
        />
        <button type="submit">ì „ì†¡</button>
      </form>
      <div id="chatLoading" class="loading" style="display:none;">ì¶”ì²œ ì¹´í˜ë¥¼ ì°¾ê³  ìˆì–´ìš”...</div>
    </div>
  </div>
</div>

<script>
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const loadingText = document.getElementById('chatLoading');
  const quickButtons = document.getElementById('quickButtons');
  const apiUrl = "{% url 'chatbot_api' %}";

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ
  if (quickButtons) {
    quickButtons.addEventListener('click', (e) => {
      const btn = e.target.closest('.chat-quick-btn');
      if (!btn) return;
      const text = btn.dataset.text || btn.textContent;
      chatInput.value = text;
      chatForm.dispatchEvent(new Event('submit'));
    });
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    chatInput.value = '';

    loadingText.style.display = 'block';
    const submitBtn = chatForm.querySelector("button[type='submit']");
    submitBtn.disabled = true;

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message }),
      });

      const data = await res.json();
      loadingText.style.display = 'none';
      submitBtn.disabled = false;

      if (!res.ok || data.error) {
        addMessage(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
        return;
      }

      addMessage(data.answer, 'bot');
      // ë””ë²„ê¹…ìš©
      // addMessage("[DEBUG SQL]\\n" + data.sql, "bot");
    } catch (err) {
      loadingText.style.display = 'none';
      submitBtn.disabled = false;
      addMessage('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
      console.error(err);
    }
  });
</script>
{% endblock %}
