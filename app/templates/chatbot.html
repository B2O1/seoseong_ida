{% extends "reference.html" %} {% block choose %}
<style>
  .chat-page {
    background: #f7f3eb;
    padding: 40px 0 80px;
  }

  .chat-card {
    max-width: 720px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
    padding: 40px 48px 32px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    border: 1px solid #eee;
  }

  .chat-greeting {
    text-align: center;
  }
  .chat-greeting-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .chat-greeting-sub {
    font-size: 14px;
    color: #999;
  }

  .chat-quick-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .chat-quick-btn {
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid #e6e4de;
    background: #fff;
    cursor: pointer;
    font-size: 13px;
    transition: transform 0.07s ease, box-shadow 0.12s ease;
  }
  .chat-quick-btn:hover {
    background: #f1e7d7;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
  }

  .chat-box {
    border-radius: 18px;
    background: #f5f5f7;
    border: 1px solid #e6e4de;
    padding: 16px 18px 12px;
    display: flex;
    flex-direction: column;
    height: 260px;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 4px;
  }

  .message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 6px 12px;
    border-radius: 14px;
    line-height: 1.5;
    white-space: pre-line;
    font-size: 14px;
  }
  .message.user {
    margin-left: auto;
    background: #fbe1a5ff;
    color: #000000ff;
    border-bottom-right-radius: 4px;
  }
  .message.bot {
    margin-right: auto;
    background: #ffffff;
    border: 1px solid #e1e1e6;
    border-bottom-left-radius: 4px;
    padding-top: 4px;
    padding-bottom: 30px;
  }

  .chat-input-row {
    margin-top: 8px;
    display: flex;
    gap: 8px;
  }
  .chat-input-row input[type='text'] {
    flex: 1;
    border-radius: 999px;
    border: 1px solid #d4d4dd;
    padding: 8px 14px;
    outline: none;
    font-size: 14px;
  }
  .chat-input-row input[type='text']:focus {
    border-color: #ffd369;
    box-shadow: 0 0 0 2px rgba(255, 179, 107, 0.25);
  }
  .chat-input-row button {
    border: none;
    border-radius: 999px;
    padding: 8px 18px;
    background: #ffd369;
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  .chat-input-row button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  .loading {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  @media (max-width: 768px) {
    .chat-card {
      margin: 0 16px;
      padding: 28px 20px 24px;
    }
    .chat-box {
      height: 50vh;
    }
  }
</style>

<div class="chat-page">
  <div class="chat-card">
    <div class="chat-greeting">
      <div class="chat-greeting-title">
        안녕하세요 {% if request.user.is_authenticated %}
        {{request.session.display_name|default:request.user.username}}님 {% else %} 반가워요 잘있어요 다시만나요
        {%endif%}
      </div>
      <div class="chat-greeting-sub">오늘은 어떤 카페를 서성이며 찾고 싶으신가요?</div>
    </div>

    <div class="chat-box">
      <div id="chatMessages" class="chat-messages">
        <div id="initialHelp" class="message bot">
          안녕하세요! ☕️<br />
          예: “연희동에서 조용하고 콘센트 많은 카페 추천해줘” 처럼 물어보면<br />
          서성이다 DB에서 조건에 맞는 카페를 찾아드릴게요.
        </div>
      </div>

      <form id="chatForm" class="chat-input-row">
        <input
          type="text"
          id="chatInput"
          placeholder="어디서 누구랑, 어떤 분위기의 카페를 찾고 있나요?"
          autocomplete="off"
        />
        <button type="submit" id="chatSubmitBtn">전송</button>
      </form>

      <div id="chatLoading" class="loading" style="display: none">추천 카페를 찾고 있어요.</div>
    </div>
  </div>
</div>

<script>
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const loadingText = document.getElementById('chatLoading');
  const quickButtons = document.getElementById('quickButtons');
  const initialHelp = document.getElementById('initialHelp');
  const submitBtn = document.getElementById('chatSubmitBtn');
  const apiUrl = "{% url 'chatbot_api' %}";

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function setLoading(isLoading) {
    loadingText.style.display = isLoading ? 'block' : 'none';
    submitBtn.disabled = isLoading;
    chatInput.disabled = isLoading;
  }

  // 빠른 선택 버튼 클릭 시
  if (quickButtons) {
    quickButtons.addEventListener('click', (e) => {
      const btn = e.target.closest('.chat-quick-btn');
      if (!btn) return;
      const text = btn.dataset.text || btn.textContent;
      chatInput.value = text;
      if (chatForm.requestSubmit) chatForm.requestSubmit();
      else chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
    });
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = chatInput.value.trim();
    if (!message) return;

    // 첫 질문 시 초기 안내 숨기기
    if (initialHelp) initialHelp.style.display = 'none';

    // ✅ 사용자 메시지를 채팅창에 바로 추가 (여기서 안 보이던 문제 해결)
    addMessage(message, 'user');

    // 입력창 비우기 + 로딩
    chatInput.value = '';
    setLoading(true);

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.error) {
        addMessage(data.error || '오류가 발생했어요.', 'bot');
        return;
      }

      addMessage(data.answer ?? '(응답이 비어있어요)', 'bot');
      // addMessage("[DEBUG SQL]\n" + (data.sql ?? ''), "bot");
    } catch (err) {
      console.error(err);
      addMessage('서버와 통신 중 오류가 발생했어요.', 'bot');
    } finally {
      setLoading(false);
      chatInput.focus();
    }
  });
</script>
{% endblock %}
