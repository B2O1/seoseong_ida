{% extends "reference.html" %}
{% load static %}
{% load tz %}

{% block activate %}
<div class="faq-detail-page">
  <div class="faq-detail-card">
    <div class="faq-detail-header">
      <h1 class="faq-detail-title">문의 상세</h1>

      <div class="faq-detail-actions">
        <a href="{% url 'faq_list' %}" class="faq-detail-btn">목록으로</a>
        {% if request.user.is_staff %}
          <a href="{% url 'faq_answer' item.pk %}" class="faq-detail-btn faq-detail-primary">
            답변 작성/수정
          </a>
        {% endif %}
      </div>
    </div>

    {# 문의 본문 #}
    <div class="faq-detail-question">
      <div class="faq-detail-meta">
        <span>{{ item.name }}</span>
        <span>· {% localtime on %}{{ item.created_at|date:"Y.m.d H:i" }}{% endlocaltime %}</span>
        <span>· {{ item.email|default:"이메일 없음" }}</span>
      </div>
      <p class="faq-detail-question-body">
        {{ item.question }}
      </p>
    </div>

    {# 관리자 답변 #}
    {% if item.answer %}
    <div class="faq-detail-answer">
      <div class="faq-detail-answer-header">관리자 답변</div>
      <p class="faq-detail-answer-body">
        {{ item.answer }}
      </p>
    </div>
    {% endif %}

    {# 댓글 영역 #}
    <div class="faq-detail-comments">
      <div class="faq-detail-comments-header">
        댓글 {{ comments|length }}개
      </div>

      <div class="faq-detail-comment-list">
        {% if comments %}
          {% for c in comments %}
          <div class="faq-detail-comment-item {% if c.is_staff %}faq-detail-comment-admin{% endif %}">
            <div class="faq-detail-meta">
              <span>{{ c.author }}</span>
              <span>· {{ c.created_at|date:"Y.m.d H:i" }}</span>
              {% if c.is_staff %}
                <span class="faq-detail-admin-badge">관리자</span>
              {% endif %}
            </div>
            <p class="faq-detail-comment-body">
              {{ c.content }}
            </p>
          </div>
          {% endfor %}
        {% else %}
          <div class="faq-detail-empty">아직 댓글이 없습니다.</div>
        {% endif %}
      </div>

      {# 로그인한 사용자만 댓글 폼 #}
      {% if request.user.is_authenticated %}
      <form method="post" class="faq-detail-form">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="comment">

        <div class="faq-detail-field">
          <label>작성자</label>
          <input
            type="text"
            value="{{ request.session.display_name|default:request.user.username }}"
            readonly
          >
        </div>

        <div class="faq-detail-field">
          {{ cform.content.label_tag }}{{ cform.content }}
          {{ cform.content.errors }}
        </div>

        <button type="submit" class="faq-detail-btn faq-detail-primary">
          댓글 등록
        </button>
      </form>
      {% else %}
      <div class="faq-detail-empty faq-detail-login-callout">
        댓글 작성은 로그인 후 이용할 수 있습니다.<br>
        <a href="{% url 'login' %}?next={{ request.path }}"
           class="faq-detail-btn faq-detail-primary">
          로그인하기
        </a>
      </div>
      {% endif %}
    </div>

    {# 하단 액션 #}
    <div class="faq-detail-actions faq-detail-actions-bottom">
      <a href="{% url 'faq_list' %}" class="faq-detail-btn">목록으로</a>
      {% if request.user.is_staff %}
        <a href="{% url 'faq_answer' item.pk %}" class="faq-detail-btn faq-detail-primary">
          답변 작성/수정
        </a>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}