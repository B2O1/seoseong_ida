{% extends "reference.html" %}

{% block choose %}
<div class="category-bar-wrapper">
  <div class="category-card">
    <ul class="category-bar">
      <button class="cat-btn" data-code="ì¾Œì¢‹ì¹´">ì¾Œì¢‹ì¹´</button>
      <button class="cat-btn" data-code="í˜¼ì¢‹ì¹´">í˜¼ì¢‹ì¹´</button>
      <button class="cat-btn" data-code="ì±…ì¢‹ì¹´">ì±…ì¢‹ì¹´</button>
      <button class="cat-btn" data-code="ì´ê±¸ì•ˆì¹´">ì´ê±¸ì•ˆì¹´</button>
      <button class="cat-btn" data-code="ë‹¨ì¢‹ì¹´">ë‹¨ì¢‹ì¹´</button>
      <button class="cat-btn" data-code="ì»¤ë§›ì¹´">ì»¤ë§›ì¹´</button>
      <button class="cat-btn" data-code="ì¹´ê³µì¹´">ì¹´ê³µì¹´</button>
      <button class="cat-btn" data-code="í™”ì²­ì¹´">í™”ì²­ì¹´</button>
      <button class="cat-btn" data-code="ë¶„ì¢‹ì¹´">ë¶„ì¢‹ì¹´</button>
      <button class="cat-btn" data-code="ë””ë§›ì¹´">ë””ë§›ì¹´</button>
      <button class="cat-btn" data-code="ê°€ì¢‹ì¹´">ê°€ì¢‹ì¹´</button>
      <button class="cat-btn" data-code="ë°˜ë™ì¹´">ë°˜ë™ì¹´</button>
      <button class="cat-btn" data-code="ë°¤ìƒ˜ì¹´í˜">ë°¤ìƒ˜ì¹´í˜</button>
      <button class="cat-btn" data-code="í•œì˜¥">í•œì˜¼ì¹´</button>
    </ul>

    <div class="category-search">
      <button id="keywordSearchBtn" type="button" class="search-icon-btn" aria-label="ê²€ìƒ‰">
        <span class="search-icon"></span>
      </button>
    </div>
  </div>
</div>

<style>
  /* ê°ˆìƒ‰ ë°°ê²½ ë  */
  .category-bar-wrapper {
    width: 100%;
    padding: 26px 0 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
  }

  /* ë²„íŠ¼ + ê²€ìƒ‰ì°½ ë“¤ì–´ê°€ëŠ” í° ì¹´ë“œ */
  .category-card {
    width: min(1080px, 100% - 40px);
    background: #ffffff;
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  /* ë²„íŠ¼ 2ì¤„ ê³ ì • (7ê°œ + 7ê°œ) */
  .category-bar {
    list-style: none;
    display: grid;
    grid-template-columns: repeat(7, auto); /* 1ì¤„ì— 7ê°œ */
    gap: 6px 8px;
    margin: 0;
    padding: 0;
    flex: 1 1 auto;
  }

  .cat-btn {
    padding: 8px 16px;
    border-radius: 22px;
    border: 1px solid #ddd;
    background: #ffffff;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }

  .cat-btn.selected {
    background: #ffebe0;
    border-color: #ffd369;
    font-weight: 700;
    color: #ffd369;
  }

  /* ì˜¤ë¥¸ìª½ ê²€ìƒ‰ì°½ + ë‹ë³´ê¸° ë²„íŠ¼ */
  .category-search {
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #ddd;
    border-radius: 999px;
    padding: 4px 8px 4px 12px;
    background: #ffffff;
    flex-shrink: 0;
  }

  .category-search input {
    border: none;
    outline: none;
    font-size: 14px;
    width: 180px;
  }

  .search-icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: #3b2b27;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* ë‹ë³´ê¸° ì•„ì´ì½˜ (ìˆœìˆ˜ CSS) */
  .search-icon {
    position: relative;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid #ffffff;
    display: inline-block;
  }
  .search-icon::after {
    content: "";
    position: absolute;
    width: 8px;
    height: 2px;
    background: #ffffff;
    border-radius: 999px;
    right: -4px;
    bottom: -1px;
    transform: rotate(45deg);
    transform-origin: left center;
  }

  .apply-btn {
    padding: 8px 20px;
    background: #ffffff;
    border-radius: 22px;
    border: 1px solid #ddd;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block title %}{% endblock %}

{% block content %}
<div class="search-page-banner">

  <div class="search-page-wrapper">
    <ul class="banner-list">
      {% for cafe in cafes %}
      <li onclick="openNaverMapPopup('{{ cafe.name|escapejs }}','{{ cafe.address|escapejs }}')" style="cursor: pointer">
        <div class="banner-list-content">
          <h3>{{ cafe.name }}</h3>
          {% if cafe.address %}
          <p class="addr">{{ cafe.address }}</p>
          {% endif %}
          {% if cafe.cats_display %}
          <p class="category" style="font-weight: bold">{{ cafe.cats_display }}</p>
          {% endif %}
        </div>
      </li>
      {% empty %}
      <li>ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ê°€ ì—†ì–´ìš”.</li>
      {% endfor %}
    </ul>
    {% if page_obj %}
    <nav
      class="pagination"
      aria-label="í˜ì´ì§€ë„¤ì´ì…˜"

    >
      {% if page_obj.has_previous %}
      <a class="px-3 py-1 border rounded" href="?page={{ page_obj.previous_page_number }}{{ qs_keep }}">ì´ì „</a>
      {% else %}
      <span class="px-3 py-1 border rounded opacity-50 cursor-not-allowed">ì´ì „</span>
      {% endif %}

      <span class="text-sm">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
      <a class="px-3 py-1 border rounded" href="?page={{ page_obj.next_page_number }}{{ qs_keep }}">ë‹¤ìŒ</a>
      {% else %}
      <span class="px-3 py-1 border rounded opacity-50 cursor-not-allowed">ë‹¤ìŒ</span>
      {% endif %}
    </nav>
    {% endif %}
  </div>
  </div>


{% endblock %}

{% block script %}
<script>
  // âœ… ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ ë§¤í•‘
  const categoryColorMap = {
    "ì¾Œì¢‹ì¹´": "#6C5CE7",
    "í˜¼ì¢‹ì¹´": "#0984E3",
    "ì±…ì¢‹ì¹´": "#00A8FF",
    "ì´ê±¸ì•ˆì¹´": "#8E44AD",
    "ë‹¨ì¢‹ì¹´": "#D35400",
    "ì»¤ë§›ì¹´": "#2ECC71",
    "ì¹´ê³µì¹´": "#00B894",
    "í™”ì²­ì¹´": "#F1C40F",
    "ë¶„ì¢‹ì¹´": "#E84393",
    "ë””ë§›ì¹´": "#E17055",
    "ê°€ì¢‹ì¹´": "#2D3436",
    "ë°˜ë™ì¹´": "#6D214F",
    "ë°¤ìƒ˜ì¹´í˜": "#34495E",
    "í•œì˜¥": "#A3CB38"
  };

  document.addEventListener("DOMContentLoaded", () => {
    // ===== ì¹´ë“œì— í‘œì‹œë˜ëŠ” ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ â†’ ì¹© ì—¬ëŸ¬ ê°œë¡œ ë³€í™˜ =====
    document.querySelectorAll(".banner-list-content .category").forEach((el) => {
      const raw = el.innerText.trim();

      if (!raw) return;

      // "ì¾Œì¢‹ì¹´ Â· í™”ì²­ì¹´", "ì¾Œì¢‹ì¹´, í™”ì²­ì¹´", "ì¾Œì¢‹ì¹´ í™”ì²­ì¹´" ë“± ì—¬ëŸ¬ í˜•íƒœë¥¼ ì»¤ë²„
      let labels = raw
        .split(/[\sÂ·,/]+/)   // ê³µë°±, ì (Â·), ì½¤ë§ˆ, ìŠ¬ë˜ì‹œ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
        .map((t) => t.trim())
        .filter((t) => t.length > 0);

      // ë§¤í•‘ì— ì—†ëŠ” ê°’ì€ ë²„ë¦¬ê³ , í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì›ë˜ í…ìŠ¤íŠ¸ ìœ ì§€
      const valid = labels.filter((t) => categoryColorMap[t]);

      if (!valid.length) return;  // ë§¤ì¹­ë˜ëŠ” ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

      // ê¸°ì¡´ í…ìŠ¤íŠ¸ ì§€ìš°ê³  ì¹©ë“¤ë¡œ ì±„ìš°ê¸°
      el.innerHTML = "";
      valid.forEach((label) => {
        const chip = document.createElement("span");
        chip.className = "cat-chip";
        chip.textContent = label;

        const color = categoryColorMap[label];
        chip.style.borderColor = color;
        chip.style.color = color;
        // ë°°ê²½ì„ ì‚´ì§ í†¤ë‹¤ìš´ ì»¬ëŸ¬ë¡œ í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ í•œ ì¤„ë„ ì¨ì¤˜ (ì„ íƒ)
        // chip.style.backgroundColor = color + "20"; // #RRGGBB20 í˜•ì‹ì´ì§€ë§Œ ë¸Œë¼ìš°ì €ë§ˆë‹¤ ë‹¬ë¼ì„œ ì£¼ì„ ì²˜ë¦¬

        el.appendChild(chip);
      });
    });
  });
  document.addEventListener("DOMContentLoaded", function () {
    const params = new URLSearchParams(window.location.search);

    // ===== ì¹´í…Œê³ ë¦¬ ì„ íƒ ì´ˆê¸°í™” =====
    const selectedCats = params.getAll("cat");
    document.querySelectorAll(".cat-btn").forEach((btn) => {
      if (selectedCats.includes(btn.dataset.code)) {
        btn.classList.add("selected");
      }
      btn.addEventListener("click", () => {
        btn.classList.toggle("selected");
      });
    });

    // ===== ì¹´í…Œê³ ë¦¬ ì ìš©í•˜ê¸° =====
    const applyBtn = document.getElementById("applyFilters");
    if (applyBtn) {
      applyBtn.addEventListener("click", function () {
        const selected = Array.from(
          document.querySelectorAll(".cat-btn.selected")
        ).map((b) => b.dataset.code);

        const p = new URLSearchParams(window.location.search);
        p.delete("cat");
        selected.forEach((c) => p.append("cat", c));
        p.set("page", 1);
        window.location.search = p.toString();
      });
    }

    // ===== ê²€ìƒ‰ì°½ / ë‹ë³´ê¸° ë²„íŠ¼ =====
    const keywordInput = document.getElementById("keywordInput");
    const keywordBtn = document.getElementById("keywordSearchBtn");

    function doSearchApply() {
      const p = new URLSearchParams(window.location.search);

      // ğŸ”¸ 1) ì¹´í…Œê³ ë¦¬ ì„ íƒ ì ìš©
      p.delete("cat");
      const selectedCats = [...document.querySelectorAll(".cat-btn.selected")].map(
        (b) => b.dataset.code
      );
      selectedCats.forEach((c) => p.append("cat", c));


      // ğŸ”¸ 3) í˜ì´ì§€ í•­ìƒ 1ë¡œ ì´ë™
      p.set("page", 1);

      // ì´ë™
      window.location.search = p.toString();
    }
    keywordBtn.addEventListener("click", doSearchApply);

    keywordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        doSearchApply();
      }
    });
  });

  // âœ… ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ íŒì—…
  function openNaverMapPopup(name, address, lat = null, lng = null) {
    if (!address && !name) {
      alert("ì§€ë„ì—ì„œ ê²€ìƒ‰í•  ì •ë³´ê°€ ì—†ì–´ìš” ğŸ˜¢");
      return;
    }
    const query = encodeURIComponent(((name || "") + " " + (address || "")).trim());
    const url = `https://map.naver.com/p/search/${query}`;
    window.open(url, "naverMapPopup");
  }
</script>
{% endblock %}