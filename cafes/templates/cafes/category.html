{% extends "reference.html" %} {% block search %} {% include "partials/home_search.html" %} {% endblock %} {% comment %}
ì´ê±° ì™œì´ë˜ë˜ {% endcomment %} {% block choose %}
<div>
  <span id="categorySelector" role="button" tabindex="0">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
</div>

<main id="categorySuggestions" class="suggestion-box hidden" aria-hidden="true">
  <div id="category_content">
    <h3>ì˜¤ëŠ˜ì€ ì–´ë–¤ ë¬´ë“œ?</h3>
    <div class="tags">
      <!-- ë²„íŠ¼ì— data-codeë¡œ ì‹¤ì œ ì¹´í…Œê³ ë¦¬ ê°’ì„ ì‹¬ì–´ë‘¡ë‹ˆë‹¤ (URL ?cat=ê°’ ìœ¼ë¡œ ì „ë‹¬) -->
      <button class="tag-btn" data-code="ì¾Œì¢‹ì¹´">ì¾Œì¢‹ì¹´</button>
      <button class="tag-btn" data-code="í˜¼ì¢‹ì¹´">í˜¼ì¢‹ì¹´</button>
      <button class="tag-btn" data-code="ì±…ì¢‹ì¹´">ì±…ì¢‹ì¹´</button>
      <button class="tag-btn" data-code="ì´ê±¸ì•ˆì¹´">ì´ê±¸ì•ˆì¹´</button>
      <button class="tag-btn" data-code="ë‹¨ì¢‹ì¹´">ë‹¨ì¢‹ì¹´</button>
      <button class="tag-btn" data-code="ì»¤ë§›ì¹´">ì»¤ë§›ì¹´</button>
      <button class="tag-btn" data-code="ì¹´ê³µì¹´">ì¹´ê³µì¹´</button>
      <button class="tag-btn" data-code="í™”ì²­ì¹´">í™”ì²­ì¹´</button>
      <button class="tag-btn" data-code="ë¶„ì¢‹ì¹´">ë¶„ì¢‹ì¹´</button>
      <button class="tag-btn" data-code="ë””ë§›ì¹´">ë””ë§›ì¹´</button>
      <button class="tag-btn" data-code="ê°€ì¢‹ì¹´">ê°€ì¢‹ì¹´</button>
      <button class="tag-btn" data-code="ë°˜ë™ì¹´">ë°˜ë™ì¹´</button>
      <button class="tag-btn" data-code="ë°¤ìƒ˜ì¹´í˜">ë°¤ìƒ˜ì¹´í˜</button>
      <button class="tag-btn" data-code="í•œì˜¥">í•œì˜¥</button>

      <button id="applyFilters" type="button">ì ìš©í•˜ê¸°</button>
    </div>
  </div>
</main>
{% endblock %} {% block title %} {% endblock %} {% block content %}
<div class="search-page-banner">
  <h3 class="search-page-header">
    ì¶”ì²œ ì¹´í˜ ë¦¬ìŠ¤íŠ¸ {% if page_obj %}<small>({{ page_obj.paginator.count }}ê³³)</small> {% elif cafes %}<small
      >({{ cafes|length }}ê³³)</small
    >{% endif %}
  </h3>

  <div class="search-page-wrapper">
    <ul class="banner-list">
      {% for cafe in cafes %}
      <li onclick="openNaverMapPopup('{{ cafe.name|escapejs }}','{{ cafe.address|escapejs }}')" style="cursor: pointer">
        <div class="banner-list-content">
          {% comment %}
          <img
            src="{{ cafe.main_photo_url|default:static('img/placeholder_cafe.jpg') }}"
            alt="{{ cafe.name }}"
            loading="lazy"
          />
          {% endcomment %}
          <h3>{{ cafe.name }}</h3>
          {% comment %} ì–˜ë„ ì—†ëŠ” ì• ë“¤ì´ ìˆì–´ì„œ ì–´ë–»ê²Œ í•´ì•¼í•˜ë‚˜.. {% endcomment %} {% comment %}
          <p>{{ cafe.time|default:"ì¹´í˜ ì„¤ëª…ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤." }}</p>
          {% endcomment %} {% if cafe.address %}
          <p class="addr">{{ cafe.address }}</p>
          {% endif %} {% comment %} ë³„ì  ì—†ëŠ” ì¹´í˜ë“¤ë„ ìˆì–´ì„œ... {% endcomment %} {% comment %} {% if cafe.rating %}
          <p class="rating">â­ {{ cafe.rating|floatformat:2 }}</p>
          {% endif %} {% endcomment %} {% if cafe.cats_display %}
          <p style="font-weight: bold" class="category">{{ cafe.cats_display }}</p>
          {% endif %}
        </div>
      </li>
      {% empty %}
      <li>ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ê°€ ì—†ì–´ìš”.</li>
      {% endfor %}
    </ul>
  </div>

  {% if page_obj %}
  <nav
    class="pagination"
    aria-label="í˜ì´ì§€ë„¤ì´ì…˜"
    style="display: flex; gap: 0.75rem; align-items: center; justify-content: center; margin-top: 1.5rem"
  >
    {% if page_obj.has_previous %}
    <a class="px-3 py-1 border rounded" href="?page={{ page_obj.previous_page_number }}{{ qs_keep }}">ì´ì „</a>
    {% else %}
    <span class="px-3 py-1 border rounded opacity-50 cursor-not-allowed">ì´ì „</span>
    {% endif %}

    <span class="text-sm">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a class="px-3 py-1 border rounded" href="?page={{ page_obj.next_page_number }}{{ qs_keep }}">ë‹¤ìŒ</a>
    {% else %}
    <span class="px-3 py-1 border rounded opacity-50 cursor-not-allowed">ë‹¤ìŒ</span>
    {% endif %}
  </nav>
  {% endif %}
</div>
{% endblock %} {% block script %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const popup = document.getElementById('categorySuggestions');
    const categorySelector = document.getElementById('categorySelector');
    const applyBtn = document.getElementById('applyFilters');

    function showSuggestions() {
      if (!popup) return;
      popup.classList.remove('hidden');
      popup.style.display = 'block';
      popup.setAttribute('aria-hidden', 'false');
    }
    function hideSuggestions() {
      if (!popup) return;
      popup.classList.add('hidden');
      popup.style.display = 'none';
      popup.setAttribute('aria-hidden', 'true');
    }

    if (categorySelector) {
      ['click', 'keydown'].forEach((evt) => {
        categorySelector.addEventListener(evt, function (e) {
          if (evt === 'keydown' && !['Enter', ' '].includes(e.key)) return;
          e.stopPropagation();
          showSuggestions();
        });
      });
    }

    document.addEventListener('click', function (event) {
      if (popup && !popup.contains(event.target) && event.target !== categorySelector) {
        hideSuggestions();
      }
    });

    if (popup) {
      popup.addEventListener('click', function (event) {
        event.stopPropagation(); // íŒì—… ë‚´ë¶€ í´ë¦­ ì‹œ ìˆ¨ê¹€ ë°©ì§€
      });
    }

    // ë²„íŠ¼ í´ë¦­ ì‹œ selected í† ê¸€ (ì´ë²¤íŠ¸ ìœ„ì„)
    const content = document.getElementById('category_content');
    if (content) {
      content.addEventListener('click', function (event) {
        const b = event.target.closest('.tag-btn');
        if (b) b.classList.toggle('selected');
      });
    }

    // í˜„ì¬ URLì˜ cat íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ ì´ˆê¸° ì„ íƒ ìƒíƒœ ë°˜ì˜
    const params = new URLSearchParams(window.location.search);
    const cats = params.getAll('cat');
    if (cats.length) {
      document.querySelectorAll('.tag-btn').forEach((btn) => {
        if (cats.includes(btn.dataset.code)) btn.classList.add('selected');
      });
    }

    // ì ìš©í•˜ê¸° â†’ ?cat=... íŒŒë¼ë¯¸í„°ë¡œ ê°±ì‹ 
    if (applyBtn) {
      applyBtn.addEventListener('click', function () {
        const selected = Array.from(document.querySelectorAll('.tag-btn.selected')).map((b) => b.dataset.code);
        const p = new URLSearchParams(window.location.search);
        p.delete('cat'); // ê¸°ì¡´ cat ì œê±°
        selected.forEach((c) => p.append('cat', c)); // ë‹¤ì¤‘ ì¶”ê°€
        p.set('page', 1); // í•„í„° ë°”ê¾¸ë©´ 1í˜ì´ì§€ë¡œ
        window.location.search = p.toString();
      });
    }
  });
  // âœ… ë„¤ì´ë²„ ì§€ë„ â€˜ì›¹ì‚¬ì´íŠ¸â€™ë¥¼ ìƒˆ ì°½ìœ¼ë¡œ ì—¬ëŠ” í•¨ìˆ˜ (ê²€ìƒ‰ ê¸°ë°˜)
  function openNaverMapPopup(name, address, lat = null, lng = null) {
    // 1) ì¢Œí‘œê°€ ìˆìœ¼ë©´ ì¢Œí‘œ ìš°ì„  (ìˆì„ ë•Œë§Œ ì“°ê³ , ì—†ë‹¤ë©´ ê²€ìƒ‰ìœ¼ë¡œ fallback)
    if (lat != null && lng != null) {
      // ì¢Œí‘œ ê¸°ë°˜ ì—´ê¸° (ì›¹): ê³µì‹ ë”¥ë§í¬ê°€ ë¬¸ì„œí™”ê°€ ì•½í•´ì„œ, ì¼ë°˜ì ìœ¼ë¡œëŠ” ê²€ìƒ‰ì´ ë” í˜¸í™˜ì„±ì´ ì¢‹ìŒ.
      // ì¢Œí‘œë§Œìœ¼ë¡œ íŠ¹ì • ì¥ì†Œê°€ ì•ˆ ì¡í ìˆ˜ ìˆì–´ ê²€ìƒ‰ë¡œì§ë¡œ fallback ì¶”ì²œ.
      const query = encodeURIComponent((name || '') + ' ' + (address || ''));
      const url = `https://map.naver.com/p/search/${query}`; // ì¢Œí‘œ URLì€ ë‹¨ë§/ë²„ì „ì— ë”°ë¼ ë¶ˆì•ˆì • â†’ ê²€ìƒ‰ ê¶Œì¥
      window.open(url, 'naverMapPopup');
      return;
    }

    // 2) ì£¼ì†Œ/ê°€ê²Œëª… ê¸°ë°˜ ê²€ìƒ‰ (ê°€ì¥ í˜¸í™˜ì„± ì¢‹ìŒ)
    if (!address && !name) {
      alert('ì§€ë„ì—ì„œ ê²€ìƒ‰í•  ì •ë³´ê°€ ì—†ì–´ìš” ğŸ˜¢');
      return;
    }
    const query = encodeURIComponent(((name || '') + ' ' + (address || '')).trim());
    const url = `https://map.naver.com/p/search/${query}`;
    window.open(url, 'naverMapPopup');
  }
</script>
{% endblock %}
